{% extends "admin_base.html" %}
{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="h3">
            <i class="fas fa-database me-2"></i>Database Dashboard
        </h2>
        <p class="text-muted">Complete overview of all database tables and their data</p>
        <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Development Mode:</strong> Passwords are visible for development purposes only. Never use this in production!
        </div>
    </div>
</div>

<!-- Database Statistics -->
<div class="row mb-4">
    <div class="col-md-2 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h6 class="mb-0">Total Users</h6>
                <h4 class="mb-0">{{ database_data.users.count }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h6 class="mb-0">Patients</h6>
                <h4 class="mb-0">{{ database_data.patients.count }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h6 class="mb-0">Doctors</h6>
                <h4 class="mb-0">{{ database_data.doctors.count }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h6 class="mb-0">Appointments</h6>
                <h4 class="mb-0">{{ database_data.appointments.count }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center">
                <h6 class="mb-0">Treatments</h6>
                <h4 class="mb-0">{{ database_data.treatments.count }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2 mb-3">
        <div class="card bg-dark text-white">
            <div class="card-body text-center">
                <h6 class="mb-0">Departments</h6>
                <h4 class="mb-0">{{ database_data.departments.count }}</h4>
            </div>
        </div>
    </div>
</div>

<!-- Database Tables -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="databaseTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                            <i class="fas fa-users me-1"></i>Users ({{ database_data.users.count }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="patients-tab" data-bs-toggle="tab" data-bs-target="#patients" type="button" role="tab">
                            <i class="fas fa-procedures me-1"></i>Patients ({{ database_data.patients.count }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="doctors-tab" data-bs-toggle="tab" data-bs-target="#doctors" type="button" role="tab">
                            <i class="fas fa-user-md me-1"></i>Doctors ({{ database_data.doctors.count }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#appointments" type="button" role="tab">
                            <i class="fas fa-calendar-check me-1"></i>Appointments ({{ database_data.appointments.count }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="departments-tab" data-bs-toggle="tab" data-bs-target="#departments" type="button" role="tab">
                            <i class="fas fa-building me-1"></i>Departments ({{ database_data.departments.count }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="treatments-tab" data-bs-toggle="tab" data-bs-target="#treatments" type="button" role="tab">
                            <i class="fas fa-notes-medical me-1"></i>Treatments ({{ database_data.treatments.count }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="admins-tab" data-bs-toggle="tab" data-bs-target="#admins" type="button" role="tab">
                            <i class="fas fa-user-shield me-1"></i>Admins ({{ database_data.admins.count }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="medical-histories-tab" data-bs-toggle="tab" data-bs-target="#medical-histories" type="button" role="tab">
                            <i class="fas fa-file-medical me-1"></i>Medical History ({{ database_data.medical_histories.count }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="availability-tab" data-bs-toggle="tab" data-bs-target="#availability" type="button" role="tab">
                            <i class="fas fa-clock me-1"></i>Availability ({{ database_data.doctor_availability.count }})
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="databaseTabsContent">
                    <!-- Users Table -->
                    <div class="tab-pane fade show active" id="users" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        {% for column in database_data.users.columns %}
                                        <th>{{ column }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in database_data.users.data %}
                                    <tr>
                                        <td>{{ user.id }}</td>
                                        <td><code>{{ user.username }}</code></td>
                                        <td>{{ user.name }}</td>
                                        <td>{{ user.email }}</td>
                                        <td><span class="badge bg-{{ 'primary' if user.role == 'admin' else 'success' if user.role == 'doctor' else 'info' }}">{{ user.role.title() }}</span></td>
                                        <td><code class="text-danger" style="font-size: 0.7rem; background: #fff3cd;">{{ user.password }}</code></td>
                                        <td><span class="badge bg-{{ 'success' if user.is_active == 'Yes' else 'danger' }}">{{ user.is_active }}</span></td>
                                        <td>{{ user.created_at }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Patients Table -->
                    <div class="tab-pane fade" id="patients" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        {% for column in database_data.patients.columns %}
                                        <th>{{ column }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for patient in database_data.patients.data %}
                                    <tr>
                                        <td>{{ patient.id }}</td>
                                        <td><code>{{ patient.patient_id }}</code></td>
                                        <td>{{ patient.name }}</td>
                                        <td>{{ patient.gender }}</td>
                                        <td>{{ patient.dob }}</td>
                                        <td><span class="badge bg-danger">{{ patient.blood_group }}</span></td>
                                        <td>{{ patient.contact }}</td>
                                        <td><small>{{ patient.address }}</small></td>
                                        <td><span class="badge bg-{{ 'success' if patient.is_active == 'Yes' else 'danger' }}">{{ patient.is_active }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Doctors Table -->
                    <div class="tab-pane fade" id="doctors" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        {% for column in database_data.doctors.columns %}
                                        <th>{{ column }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for doctor in database_data.doctors.data %}
                                    <tr>
                                        <td>{{ doctor.id }}</td>
                                        <td><code>{{ doctor.license }}</code></td>
                                        <td>{{ doctor.name }}</td>
                                        <td><span class="badge bg-primary">{{ doctor.department }}</span></td>
                                        <td>{{ doctor.specialization }}</td>
                                        <td>{{ doctor.experience }}</td>
                                        <td>{{ doctor.fee }}</td>
                                        <td><span class="badge bg-{{ 'success' if doctor.status == 'active' else 'warning' }}">{{ doctor.status.title() }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Appointments Table -->
                    <div class="tab-pane fade" id="appointments" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        {% for column in database_data.appointments.columns %}
                                        <th>{{ column }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for appointment in database_data.appointments.data %}
                                    <tr>
                                        <td>{{ appointment.id }}</td>
                                        <td><code>{{ appointment.appointment_number }}</code></td>
                                        <td>{{ appointment.patient }}</td>
                                        <td>{{ appointment.doctor }}</td>
                                        <td>{{ appointment.date }}</td>
                                        <td>{{ appointment.time }}</td>
                                        <td><span class="badge bg-{{ 'success' if appointment.status == 'Completed' else 'warning' if appointment.status == 'Booked' else 'danger' }}">{{ appointment.status }}</span></td>
                                        <td>{{ appointment.fee }}</td>
                                        <td><span class="badge bg-{{ 'success' if appointment.payment == 'Paid' else 'warning' }}">{{ appointment.payment }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Departments Table -->
                    <div class="tab-pane fade" id="departments" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        {% for column in database_data.departments.columns %}
                                        <th>{{ column }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for department in database_data.departments.data %}
                                    <tr>
                                        <td>{{ department.id }}</td>
                                        <td><strong>{{ department.name }}</strong></td>
                                        <td>{{ department.description }}</td>
                                        <td><span class="badge bg-info">{{ department.doctors_count }}</span></td>
                                        <td>{{ department.created_at }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Treatments Table -->
                    <div class="tab-pane fade" id="treatments" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        {% for column in database_data.treatments.columns %}
                                        <th>{{ column }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for treatment in database_data.treatments.data %}
                                    <tr>
                                        <td>{{ treatment.id }}</td>
                                        <td>{{ treatment.patient }}</td>
                                        <td>{{ treatment.doctor }}</td>
                                        <td>{{ treatment.date }}</td>
                                        <td><small>{{ treatment.diagnosis }}</small></td>
                                        <td><small>{{ treatment.prescription }}</small></td>
                                        <td>{{ treatment.bp }}</td>
                                        <td>{{ treatment.hr }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Admins Table -->
                    <div class="tab-pane fade" id="admins" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        {% for column in database_data.admins.columns %}
                                        <th>{{ column }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for admin in database_data.admins.data %}
                                    <tr>
                                        <td>{{ admin.id }}</td>
                                        <td><strong>{{ admin.name }}</strong></td>
                                        <td><code>{{ admin.username }}</code></td>
                                        <td>{{ admin.created_at }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Medical Histories Table -->
                    <div class="tab-pane fade" id="medical-histories" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        {% for column in database_data.medical_histories.columns %}
                                        <th>{{ column }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for history in database_data.medical_histories.data %}
                                    <tr>
                                        <td>{{ history.id }}</td>
                                        <td>{{ history.patient }}</td>
                                        <td><small>{{ history.allergies }}</small></td>
                                        <td><small>{{ history.chronic_conditions }}</small></td>
                                        <td><small>{{ history.medications }}</small></td>
                                        <td>{{ history.last_updated }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Doctor Availability Table -->
                    <div class="tab-pane fade" id="availability" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        {% for column in database_data.doctor_availability.columns %}
                                        <th>{{ column }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for availability in database_data.doctor_availability.data %}
                                    <tr>
                                        <td>{{ availability.id }}</td>
                                        <td>{{ availability.doctor }}</td>
                                        <td>{{ availability.date }}</td>
                                        <td>{{ availability.start_time }}</td>
                                        <td>{{ availability.end_time }}</td>
                                        <td><span class="badge bg-{{ 'success' if availability.available == 'Yes' else 'danger' }}">{{ availability.available }}</span></td>
                                        <td>{{ availability.max_appointments }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Database Summary -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Database Summary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>Total Tables</h6>
                        <p class="h4 text-primary">{{ database_data.summary.total_tables }}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Total Records</h6>
                        <p class="h4 text-success">{{ database_data.summary.total_records }}</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Largest Table</h6>
                        <p class="h4 text-info">{{ database_data.summary.largest_table.title() }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Options -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-download me-2"></i>Export & Actions</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Database management and export options.</p>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="refreshData()">
                        <i class="fas fa-sync me-1"></i>Refresh Data
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="exportToJSON()">
                        <i class="fas fa-file-code me-1"></i>Export JSON
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="printReport()">
                        <i class="fas fa-print me-1"></i>Print Report
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="showSQL()">
                        <i class="fas fa-database me-1"></i>Show SQL
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Refresh data
function refreshData() {
    location.reload();
}

// Export functions
function exportToJSON() {
    const data = {{ database_data | tojson }};
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'database_export_' + new Date().toISOString().split('T')[0] + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function printReport() {
    window.print();
}

function showSQL() {
    alert('SQL query functionality would show the actual database queries used to generate this data.');
}

// Search functionality for tables
function addSearchToTable(tableId) {
    const table = document.querySelector(`#${tableId} table`);
    if (!table) return;
    
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control mb-3';
    searchInput.placeholder = 'Search in this table...';
    
    table.parentNode.insertBefore(searchInput, table);
    
    searchInput.addEventListener('keyup', function() {
        const filter = this.value.toLowerCase();
        const rows = table.getElementsByTagName('tr');
        
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const cells = row.getElementsByTagName('td');
            let found = false;
            
            for (let j = 0; j < cells.length; j++) {
                if (cells[j].textContent.toLowerCase().includes(filter)) {
                    found = true;
                    break;
                }
            }
            
            row.style.display = found ? '' : 'none';
        }
    });
}

// Initialize when document is ready
document.addEventListener('DOMContentLoaded', function() {
    // Add search functionality to all tables
    const tabPanes = ['users', 'patients', 'doctors', 'appointments', 'departments', 'treatments', 'admins', 'medical-histories', 'availability'];
    tabPanes.forEach(pane => addSearchToTable(pane));
    
    console.log('Database dashboard loaded with {{ database_data.summary.total_records }} total records');
});
</script>

<style>
.table th {
    font-size: 0.8rem;
    font-weight: 600;
    white-space: nowrap;
}

.table td {
    font-size: 0.8rem;
    vertical-align: middle;
}

.table-responsive {
    max-height: 500px;
    overflow-y: auto;
}

.nav-tabs .nav-link {
    font-size: 0.85rem;
    padding: 0.5rem 0.75rem;
}

.badge {
    font-size: 0.7rem;
}

code {
    font-size: 0.75rem;
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
}

.alert {
    font-size: 0.9rem;
}

/* Password column styling */
.text-danger code {
    background-color: #fff3cd !important;
    color: #721c24 !important;
    border: 1px solid #f5c6cb;
}
</style>
{% endblock %}